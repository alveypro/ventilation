from pathlib import Path

ROOT = Path(__file__).resolve().parents[1]
SRC_DIR = ROOT / "data" / "sources" / "呼吸机之家_50篇百科完整版"


def section(title, body_lines):
    lines = [f"## {title}"]
    lines.extend(body_lines)
    return "\n".join(lines)


def build_metric(title, definition, why, how, thresholds, pitfalls, faq):
    return "\n\n".join([
        f"# {title}",
        section("一句话定义", [definition]),
        section("临床意义", [why]),
        section("怎么看", [f"- {item}" for item in how]),
        section("常用分层/阈值", [f"- {item}" for item in thresholds]),
        section("常见误区", [f"- {item}" for item in pitfalls]),
        section("FAQ", [f"**Q：{faq[0]}**  ", f"A：{faq[1]}"])
    ])


def build_concept(title, definition, plain, points, process, pitfalls, faq):
    return "\n\n".join([
        f"# {title}",
        section("一句话定义", [definition]),
        section("通俗解释", [plain]),
        section("核心要点", [f"- {item}" for item in points]),
        section("建议流程", [f"{idx+1}. {item}" for idx, item in enumerate(process)]),
        section("常见误区", [f"- {item}" for item in pitfalls]),
        section("FAQ", [f"**Q：{faq[0]}**  ", f"A：{faq[1]}"])
    ])


def build_mode(title, definition, indications, parameters, cautions, faq):
    return "\n\n".join([
        f"# {title}",
        section("一句话定义", [definition]),
        section("适用场景", [f"- {item}" for item in indications]),
        section("关键参数", [f"- {item}" for item in parameters]),
        section("风险与注意事项", [f"- {item}" for item in cautions]),
        section("FAQ", [f"**Q：{faq[0]}**  ", f"A：{faq[1]}"])
    ])


def build_user(title, definition, steps, tips, pitfalls, faq):
    return "\n\n".join([
        f"# {title}",
        section("一句话定义", [definition]),
        section("操作步骤", [f"{idx+1}. {item}" for idx, item in enumerate(steps)]),
        section("实用技巧", [f"- {item}" for item in tips]),
        section("常见误区", [f"- {item}" for item in pitfalls]),
        section("FAQ", [f"**Q：{faq[0]}**  ", f"A：{faq[1]}"])
    ])


def build_disease(title, definition, diagnosis, treatment, followup, warnings, faq):
    return "\n\n".join([
        f"# {title}",
        section("一句话定义", [definition]),
        section("诊断要点", [f"- {item}" for item in diagnosis]),
        section("治疗策略", [f"- {item}" for item in treatment]),
        section("随访要点", [f"- {item}" for item in followup]),
        section("风险提示", [f"- {item}" for item in warnings]),
        section("FAQ", [f"**Q：{faq[0]}**  ", f"A：{faq[1]}"])
    ])


def build_resp_therapy(title, definition, indications, parameters, cautions, faq):
    return build_mode(title, definition, indications, parameters, cautions, faq)


def content_for(filename):
    stem = filename.stem
    title = stem.split("_", 1)[1]

    if title == "什么是睡眠呼吸暂停":
        return build_concept(
            title,
            "睡眠时反复出现呼吸暂停或低通气，导致低氧与觉醒增多的睡眠呼吸障碍。",
            "就像睡觉时呼吸不断“卡顿”，身体被迫反复醒来修复呼吸节奏。",
            [
                "典型表现为打鼾、夜间憋醒、白天嗜睡",
                "与肥胖、上气道狭窄、年龄相关",
                "可增加高血压与心血管风险",
            ],
            [
                "筛查量表评估风险",
                "PSG/HSAT 确认事件与低氧负荷",
                "评估适应证后选择 PAP 治疗",
            ],
            [
                "只看打鼾就自行判断",
                "忽视低氧与并发症",
            ],
            ("打鼾一定就是睡眠呼吸暂停吗？", "不一定，但打鼾合并嗜睡或低氧要尽快评估。"),
        )

    metrics = {
        "AHI指标详解": (
            "AHI 是每小时睡眠中呼吸暂停+低通气的次数。",
            "用于评估睡眠呼吸障碍的严重度与治疗效果。",
            ["结合 PSG/HSAT 计算", "需和症状、低氧负荷一起看"],
            ["轻度 5-14", "中度 15-29", "重度 ≥30"],
            ["仅看 AHI 不看低氧", "把短暂觉醒忽略"],
            ("AHI 正常就一定没问题吗？", "不一定，仍需结合症状与其他指标。"),
        ),
        "RDI与AHI的区别": (
            "RDI = AHI + RERA，更能反映睡眠碎片化。",
            "UARS 或轻度患者可能 AHI 不高但 RDI 升高。",
            ["RDI 包含呼吸努力相关觉醒", "解释症状时更敏感"],
            ["AHI 低但 RDI 高提示上气道阻力", "需要结合 PSG"],
            ["误把 RDI 当成 AHI", "忽略 RERA"],
            ("RDI 高需要治疗吗？", "结合症状与医生评估决定。"),
        ),
        "觉醒指数ArI": (
            "ArI 是每小时觉醒次数，反映睡眠碎片化。",
            "觉醒多会导致白天嗜睡与睡眠质量差。",
            ["与呼吸事件、腿动相关", "评估治疗后是否下降"],
            ["不同年龄有差异", "单独指标不代表疾病严重度"],
            ["忽视觉醒原因", "把觉醒全归因于呼吸暂停"],
            ("ArI 高该怎么办？", "需要结合病因评估并优化治疗。"),
        ),
        "ODI是什么": (
            "ODI 是每小时血氧下降次数。",
            "反映夜间低氧负荷，与心血管风险相关。",
            ["常用 3% 或 4% 下降阈值", "结合 T90 观察低氧持续时间"],
            ["ODI 高提示低氧负荷重", "需评估治疗"],
            ["只看最低血氧忽略 ODI"],
            ("ODI 和 AHI 哪个更重要？", "二者互补，需结合症状与 T90。"),
        ),
        "T90指标解读": (
            "T90 是血氧低于 90% 的时间比例。",
            "体现低氧持续时间，对慢病影响更直接。",
            ["关注夜间低氧负荷", "评估治疗前后改善"],
            ["T90 >10% 提示低氧负荷明显"],
            ["忽视持续低氧", "只看 AHI"],
            ("T90 正常但 AHI 高怎么办？", "仍需评估症状和治疗策略。"),
        ),
    }
    if title in metrics:
        return build_metric(title, *metrics[title])

    concepts = {
        "阻塞性与中枢性呼吸暂停": (
            "阻塞性事件为气道塌陷，中枢性事件为呼吸驱动消失。",
            "一个是“气道被堵”，一个是“呼吸信号没发出”。",
            ["阻塞性有胸腹努力", "中枢性努力消失", "混合性需分段判断"],
            ["通过胸腹带与气流通道判读", "结合病因评估"],
            ["把所有事件当阻塞", "忽略中枢病因"],
            ("中枢性需要 PAP 吗？", "需先评估病因与适应证。"),
        ),
        "多导睡眠监测PSG解析": (
            "PSG 是睡眠呼吸障碍诊断金标准，记录脑电、呼吸与血氧。",
            "就像给睡眠做一场“全方位体检”。",
            ["睡眠分期、事件、低氧负荷", "区分阻塞与中枢", "评估觉醒与腿动"],
            ["关注完整通道与报告结构", "结合症状解释"],
            ["仅看 AHI 忽视睡眠结构"],
            ("HSAT 能代替 PSG 吗？", "轻症筛查可用，复杂病例仍需 PSG。"),
        ),
        "家用睡眠监测靠谱吗": (
            "家用监测适合筛查，但无法替代 PSG 的全面评估。",
            "像家庭血压计可筛查，但不能替代医院评估。",
            ["适合中低风险筛查", "复杂病例准确性受限"],
            ["出现症状仍需 PSG 复核"],
            ["把 HSAT 当确诊依据"],
            ("什么时候必须做 PSG？", "合并慢病、治疗不佳或疑难病例。"),
        ),
        "REM睡眠的重要性": (
            "REM 期肌张力降低，呼吸事件更易加重。",
            "REM 就像身体“深度放松”，气道更易塌陷。",
            ["REM 相关 OSA 常见", "需覆盖最差期"],
            ["关注 REM 期 AHI 与低氧"],
            ["忽略 REM 加重"],
            ("REM 期加重怎么办？", "参数需覆盖 REM 期需求。"),
        ),
        "仰卧性OSA": (
            "仰卧位事件明显加重的 OSA 类型。",
            "仰卧就像气道“更容易塌”。",
            ["体位改变可明显改善", "可配合体位治疗"],
            ["PSG 体位通道辅助判断"],
            ["只在侧卧测试压力"],
            ("体位治疗能替代 PAP 吗？", "轻症可尝试，重症仍需 PAP。"),
        ),
        "夜间低氧的危害": (
            "夜间反复低氧会增加心脑血管风险与认知下降。",
            "像长期“间歇缺氧”，身体负担加重。",
            ["与高血压、心律失常相关", "影响睡眠质量"],
            ["需结合 ODI/T90 评估"],
            ["只看 AHI 不看低氧"],
            ("低氧可以用氧疗解决吗？", "需根据病因评估，不能替代 PAP。"),
        ),
        "打鼾一定是OSA吗": (
            "打鼾是风险提示，但不是 OSA 的充分诊断。",
            "打鼾像“警报灯”，需要进一步检查。",
            ["伴嗜睡、憋醒需警惕", "鼻阻塞或肥胖可导致打鼾"],
            ["量表筛查+监测确认"],
            ["只凭打鼾判断"],
            ("轻度打鼾要治疗吗？", "看症状与风险，必要时评估。"),
        ),
        "UARS上气道阻力综合征": (
            "UARS 为上气道阻力升高导致觉醒增多，AHI 可能不高。",
            "像气道“变窄”，呼吸更费力。",
            ["RERA 增多", "白天疲劳明显"],
            ["PSG 判读 RERA"],
            ["用 AHI 否定症状"],
            ("UARS 需要 PAP 吗？", "部分患者可尝试 PAP 或其他治疗。"),
        ),
        "睡眠结构异常": (
            "睡眠结构异常指 N1/N2/N3/REM 比例异常或碎片化。",
            "像睡眠“节奏被打乱”。",
            ["可能由呼吸事件、药物、压力等导致", "需结合 PSG"],
            ["观察睡眠效率与觉醒"],
            ["只看总睡眠时长"],
            ("结构异常一定是疾病吗？", "需结合临床背景判断。"),
        ),
    }
    if title in concepts:
        return build_concept(title, *concepts[title])

    modes = {
        "CPAP原理": (
            "CPAP 通过持续正压撑开上气道，防止塌陷。",
            ["OSA 一线治疗", "打鼾与低通气明显"],
            ["设定固定压力", "关注漏气与舒适度"],
            ["压力过高导致不耐受", "忽视湿化"],
            ("CPAP 和 APAP 哪个好？", "需结合病情与耐受性选择。"),
        ),
        "APAP工作机制": (
            "APAP 根据事件与流量自动调节压力。",
            ["压力需求波动明显", "体位或 REM 加重"],
            ["设定上下限", "关注算法差异"],
            ["下限过低导致残余事件", "漏气影响调压"],
            ("APAP 可以随便用吗？", "需设定合适范围并随访。"),
        ),
        "双水平BiPAP详解": (
            "BiPAP 提供吸气/呼气双水平压力以改善通气与舒适度。",
            ["高压不耐受", "通气不足", "合并低通气"],
            ["IPAP/EPAP 与压力支持", "备份频率（如有）"],
            ["参数设置不当导致不耐受", "漏气干扰"],
            ("BiPAP 比 CPAP 更好吗？", "并非人人需要，需评估适应证。"),
        ),
        "S与ST模式区别": (
            "S 模式依赖自主触发，ST 增加后备频率。",
            ["S 适合自主呼吸稳定", "ST 适合驱动不足"],
            ["备份频率设置", "触发灵敏度"],
            ["后备频率过高影响舒适度"],
            ("什么时候选 ST？", "有中枢或通气不足风险时考虑。"),
        ),
        "后备频率详解": (
            "后备频率用于在自主呼吸不足时提供最低通气保障。",
            ["S/T 或 ST 模式", "呼吸驱动不足"],
            ["设置合适频率", "避免人机不同步"],
            ["频率过高导致不适"],
            ("后备频率越高越好吗？", "需要与患者节律匹配。"),
        ),
        "目标潮气量AVAPS_iVAPS": (
            "AVAPS/iVAPS 以目标通气量为导向自动调节压力。",
            ["慢性通气不足", "病情波动"],
            ["目标潮气量/通气量", "最大/最小压力限制"],
            ["设置不当导致通气不足或过度"],
            ("适合家用吗？", "需专业评估与随访。"),
        ),
        "ASV是什么": (
            "ASV 用于处理复杂性或中枢性呼吸事件的自适应通气模式。",
            ["复杂性睡眠呼吸暂停", "中枢事件占比高"],
            ["通气目标与压力支持调节"],
            ["部分心衰患者可能禁用", "必须严格评估"],
            ("可以自行选择 ASV 吗？", "不建议，必须由专业评估。"),
        ),
        "EPAP与IPAP": (
            "EPAP 主要解决阻塞，IPAP 提供通气支持。",
            ["阻塞事件与通气不足并存"],
            ["EPAP 定气道开放", "IPAP-EPAP=PS"],
            ["只调 IPAP 忽视阻塞"],
            ("先调哪个？", "先 EPAP 控制阻塞，再调 IPAP。"),
        ),
        "压力支持PS": (
            "PS = IPAP - EPAP，用于改善通气与二氧化碳排出。",
            ["通气不足", "CO2 潴留"],
            ["逐步调整 PS", "关注舒适度"],
            ["PS 过高导致不适"],
            ("PS 越高越好吗？", "需结合通气目标与耐受。"),
        ),
    }
    if title in modes:
        return build_mode(title, *modes[title])

    user_topics = {
        "漏气的影响": (
            "漏气会干扰压力与事件识别，降低治疗效果。",
            ["检查面罩贴合", "调整头带松紧", "排查口漏"],
            ["先调面罩，再调参数", "记录漏气与 AHI 变化"],
            ["只加压力不处理漏气"],
            ("漏气多少算高？", "参考设备阈值与医生建议。"),
        ),
        "触发与同步性": (
            "人机同步性决定舒适度与有效通气。",
            ["观察触发延迟", "调整触发灵敏度", "优化面罩"],
            ["漏气会影响同步", "必要时切换模式"],
            ["只看数据不问感受"],
            ("同步差怎么办？", "先排除漏气，再调触发/循环。"),
        ),
        "结露问题": (
            "结露是湿化与环境温差导致的水滴积聚。",
            ["降低湿化档位", "使用加温管路", "提高室温"],
            ["管路保温", "水箱每日清洁"],
            ["湿化过高导致噪音"],
            ("结露会影响治疗吗？", "会影响舒适度并增加噪音。"),
        ),
        "呼吸机噪音来源": (
            "噪音多来自漏气、风机与管路振动。",
            ["检查面罩漏气", "调整管路摆放", "使用隔音垫"],
            ["保持滤芯清洁", "避免床头共振"],
            ["忽视漏气导致噪音"],
            ("噪音突然变大怎么办？", "先检查管路与面罩是否松动。"),
        ),
        "呼吸机数据怎么看": (
            "重点关注 AHI、漏气、使用时长与压力趋势。",
            ["查看 AHI 与漏气", "关注使用时长", "记录主观感受"],
            ["趋势比单次更重要", "不懂的指标咨询医生"],
            ["只看 AHI 不看漏气"],
            ("需要每天看吗？", "前期建议每周查看一次趋势。"),
        ),
        "治疗效果评估": (
            "疗效评估结合症状改善与数据指标。",
            ["记录嗜睡、夜尿、晨起头痛变化", "对比 AHI/ODI"],
            ["关注依从性", "必要时复诊"],
            ["只看数据不问症状"],
            ("多久评估一次？", "一般 2-4 周复盘一次。"),
        ),
        "AHI降了还不舒服": (
            "AHI 下降但仍不适，可能与低氧/觉醒/漏气相关。",
            ["检查 T90/ODI", "评估觉醒与睡眠结构", "排查漏气"],
            ["结合睡眠卫生", "必要时复诊"],
            ["认为 AHI 降就一定好"],
            ("需要换模式吗？", "需结合评估决定。"),
        ),
        "CPAP不耐受怎么办": (
            "不耐受多与压力、面罩或心理因素有关。",
            ["降低压力或启用呼气减压", "更换面罩", "分段适应"],
            ["逐步延长时长", "记录不适点"],
            ["硬撑导致放弃"],
            ("多久能适应？", "多数人 1-2 周内逐步改善。"),
        ),
        "面罩类型选择": (
            "面罩选择影响漏气与舒适度。",
            ["鼻枕轻便但易口漏", "鼻罩平衡", "全脸罩适合口漏"],
            ["按鼻梁高度选尺寸", "避免压痕"],
            ["只看价格不看适配"],
            ("如何知道合适？", "试戴并观察漏气与舒适度。"),
        ),
        "加湿器作用": (
            "湿化可缓解鼻干与咽干，提升舒适度。",
            ["根据季节调整档位", "配合加温管路减少结露"],
            ["水箱每日清洁", "避免霉菌"],
            ["湿化过高导致结露"],
            ("必须用湿化器吗？", "多数人建议使用，尤其干燥环境。"),
        ),
        "旅行呼吸机能否替代": (
            "旅行机便携但性能与舒适度可能略弱。",
            ["短期旅行可用", "重症患者谨慎"],
            ["确认电源适配", "准备备用面罩"],
            ["长期替代主机"],
            ("飞机上能用吗？", "需确认航空公司与电源支持。"),
        ),
        "依从性管理": (
            "依从性决定治疗长期效果。",
            ["设定每日目标", "使用打卡或提醒", "定期随访"],
            ["先解决不适再谈时长"],
            ["只看时长忽视质量"],
            ("最低使用多久有效？", "常用口径为每晚 ≥4 小时。"),
        ),
        "二手呼吸机风险": (
            "二手设备存在消毒、耗材与版本风险。",
            ["核对使用小时数", "确认召回与版本", "更换耗材"],
            ["避免无来源设备"],
            ["只看价格忽视风险"],
            ("能买吗？", "不建议，若购买需严格核查。"),
        ),
        "消毒与清洁": (
            "清洁可降低感染与异味。",
            ["水箱每日清洁", "管路每周清洗", "过滤棉按月更换"],
            ["用温和清洁剂", "充分晾干"],
            ["高温或刺激性消毒"],
            ("能用酒精吗？", "多数配件不建议使用酒精。"),
        ),
        "何时必须就医": (
            "出现严重不适或低氧应及时就医。",
            ["持续呼吸困难", "胸痛或咯血", "意识改变"],
            ["先就医再调整设备"],
            ["靠自调参数拖延"],
            ("轻度不适需要就医吗？", "先咨询随访团队，严重则就医。"),
        ),
        "呼吸机能用多久": (
            "寿命与维护相关，通常 4-6 年为常见范围。",
            ["定期更换耗材", "保持清洁与通风"],
            ["关注噪音与性能下降"],
            ["长期不换耗材"],
            ("如何判断该换机？", "故障频繁或性能下降明显时。"),
        ),
    }
    if title in user_topics:
        return build_user(title, *user_topics[title])

    disease_topics = {
        "无创通气适应症": (
            "无创通气适用于通气不足或呼吸衰竭风险人群。",
            ["COPD 高碳酸血症", "神经肌肉病", "OHS"],
            ["S/T 或目标通气策略", "结合病因治疗"],
            ["建立随访计划", "关注 CO2 与依从性"],
            ["急性呼衰需严密监护", "意识障碍需谨慎"],
            ("家用 NIV 适合所有人吗？", "需专业评估后决定。"),
        ),
        "COPD夜间通气": (
            "COPD 夜间通气用于改善高碳酸血症与夜间通气不足。",
            ["血气分析提示 CO2 潴留", "夜间低氧明显"],
            ["NIV 支持", "氧疗与肺康复"],
            ["复查血气与症状", "监测急性加重"],
            ["不当设置可加重不适"],
            ("要不要长期使用？", "视病情与随访评估。"),
        ),
        "肥胖低通气综合征": (
            "肥胖导致慢性低通气与高碳酸血症。",
            ["血气分析确认", "PSG 评估合并 OSA"],
            ["PAP 或 NIV", "体重管理"],
            ["定期复诊", "监测 CO2 变化"],
            ["忽视体重管理"],
            ("体重减轻会改善吗？", "大多可明显改善。"),
        ),
        "神经肌肉病通气": (
            "神经肌肉病导致呼吸肌无力，需要通气支持。",
            ["夜间低氧或高 CO2", "咳嗽无力"],
            ["NIV 支持", "咳嗽辅助"],
            ["随访呼吸肌功能", "预防感染"],
            ["忽视排痰管理"],
            ("何时开始 NIV？", "出现夜间低通气或症状时评估。"),
        ),
    }
    if title in disease_topics:
        return build_disease(title, *disease_topics[title])

    resp_topics = {
        "氧疗基础": (
            "氧疗用于纠正低氧血症并改善组织氧合。",
            ["低氧血症", "慢病氧合不足"],
            ["目标 SpO2 90-92%（个体化）", "COPD 患者避免过度氧疗"],
            ["需监测 CO2 潴留", "防止氧中毒"],
            ("氧疗能替代通气支持吗？", "不能，需结合病因治疗。"),
        ),
        "高流量氧疗HFNC": (
            "HFNC 提供加温加湿的高流量氧气，改善氧合。",
            ["低氧性呼衰", "术后支持"],
            ["流量 30-60 L/min", "FiO2 设定"],
            ["需监测呼吸功", "不能替代无创通气"],
            ("HFNC 和 NIV 怎么选？", "根据病情与医生评估。"),
        ),
        "雾化吸入原理": (
            "雾化将药物转为微粒进入气道。",
            ["哮喘、COPD 等气道疾病"],
            ["粒径与流量影响沉积", "结合面罩/接口"],
            ["不当清洁导致感染"],
            ("可以和呼吸机一起用吗？", "需配合专业接口与流程。"),
        ),
        "气道廓清": (
            "气道廓清用于促进分泌物排出。",
            ["支气管扩张、神经肌肉病"],
            ["体位引流、PEP、机械排痰"],
            ["需评估心肺耐受"],
            ("每天都需要吗？", "按医生建议制定频率。"),
        ),
        "咳嗽辅助MI_E": (
            "MI-E 通过正负压模拟咳嗽帮助排痰。",
            ["神经肌肉病", "咳嗽无力"],
            ["吸气/呼气压设定", "频次与节律"],
            ["不当参数会不适"],
            ("家用安全吗？", "需专业指导与随访。"),
        ),
    }
    if title in resp_topics:
        return build_resp_therapy(title, *resp_topics[title])

    return build_concept(
        title,
        f"{title}是呼吸治疗中的常见主题，需要结合临床路径理解。",
        "像是理解治疗流程中的一个关键环节。",
        ["与睡眠呼吸或通气支持相关", "需结合症状与指标"],
        ["确定需求", "结合监测评估", "制定随访"],
        ["单一指标判断", "忽视随访"],
        ("普通用户需要了解吗？", "基础了解有助于更好配合治疗。"),
    )


def main():
    for path in sorted(SRC_DIR.glob("*.md")):
        content = content_for(path)
        path.write_text(content + "\n", encoding="utf-8")


if __name__ == "__main__":
    main()
