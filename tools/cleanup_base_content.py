import json
import re
from pathlib import Path

ROOT = Path(__file__).resolve().parents[1]
CLINICAL_PATH = ROOT / "src" / "data" / "clinical-handbook.ts"
USER_PATH = ROOT / "src" / "data" / "public-user-library.ts"


def load_array(path: Path, export_name: str):
    text = path.read_text(encoding="utf-8")
    marker = f"export const {export_name} = "
    start = text.find(marker)
    if start == -1:
        raise RuntimeError(f"{export_name} not found")
    array_start = text.find("[", start)
    array_end = text.rfind("]")
    payload = text[array_start:array_end + 1]
    payload = re.sub(r"([\s,{])([a-zA-Z0-9_]+)\s*:", r"\1\"\2\":", payload)
    payload = payload.replace("'", '"')
    payload = re.sub(r",\s*([}\]])", r"\1", payload)
    return text, json.loads(payload)


def save_array(path: Path, text: str, export_name: str, data):
    payload = json.dumps(data, ensure_ascii=False, indent=2)
    marker = f"export const {export_name} = "
    start = text.find(marker)
    array_start = text.find("[", start)
    array_end = text.rfind("]")
    updated = text[:array_start] + payload + text[array_end + 1:]
    path.write_text(updated, encoding="utf-8")


def summary_from_content(content: str):
    for line in content.splitlines():
        if line.startswith("## 一句话定义"):
            continue
        if line.strip() and not line.startswith("#"):
            return line.strip()
    return "内容摘要待补充"


CLINICAL = {
    "睡眠呼吸障碍（SDB）概览": """
# 睡眠呼吸障碍（SDB）概览

## 一句话定义
SDB 是一组以睡眠中呼吸事件异常为特征的疾病谱，包括 OSA、CSA、UARS 与睡眠低通气。

## 核心类型
- OSA：上气道塌陷导致阻塞事件。
- CSA：中枢驱动不足导致呼吸暂停。
- UARS：气道阻力增加、觉醒增多。
- 睡眠低通气：通气不足与 CO2 潴留。

## 诊疗路径
1. 风险筛查（STOP-Bang/ESS）。
2. PSG/HSAT 确认事件与低氧负荷。
3. 根据症状、AHI/T90 分层治疗。

## 治疗概览
- PAP 为 OSA 一线治疗。
- NIV 用于通气不足与慢性呼衰。
- 随访关注依从性与低氧改善。

## 常见误区
- 只看打鼾忽略低氧。
- 仅凭 AHI 判断治疗效果。

## FAQ
**Q：SDB 都必须用呼吸机吗？**  
A：不一定，需要结合严重度与症状评估。
""".strip(),
    "OSA诊断流程与分层": """
# OSA诊断流程与分层

## 一句话定义
通过筛查量表与睡眠监测，结合症状与低氧负荷完成 OSA 分层。

## 诊断流程
1. 量表筛查与症状评估。
2. PSG 或 HSAT 确认事件。
3. 结合 AHI、ODI、T90 与合并症分层。

## 分层要点
- 轻度：AHI 5–14。
- 中度：AHI 15–29。
- 重度：AHI ≥30。

## 临床提示
- 低氧负荷与合并症同样重要。
- 体位/REM 加重需特别记录。

## FAQ
**Q：AHI 不高就没问题吗？**  
A：不一定，需结合症状与 RDI/T90。
""".strip(),
    "PSG通道与报告速读": """
# PSG通道与报告速读

## 一句话定义
PSG 通过多通道记录睡眠结构与呼吸事件，是诊断金标准。

## 关键通道
- EEG/EOG/EMG：睡眠分期与觉醒。
- 气流/胸腹带：阻塞 vs 中枢。
- SpO2：低氧负荷。
- 体位/鼾声/ECG：辅助判断。

## 报告速读顺序
1. 睡眠结构与效率。
2. AHI/RDI/ODI/T90。
3. 体位与 REM 期事件。

## FAQ
**Q：HSAT 可以替代 PSG 吗？**  
A：轻症筛查可用，复杂病例需 PSG。
""".strip(),
    "呼吸事件判读要点": """
# 呼吸事件判读要点

## 一句话定义
判读呼吸事件需区分阻塞、中枢与混合类型。

## 判读关键
- 阻塞性：气流下降+胸腹努力仍在。
- 中枢性：气流下降+胸腹努力消失。
- 低通气：气流下降并伴低氧/觉醒。

## 常见误区
- 只看气流不看胸腹带。
- 忽略体位/REM 期影响。

## FAQ
**Q：混合性事件怎么判断？**  
A：前段无努力、后段出现努力为混合性。
""".strip(),
    "PAP模式选择原则": """
# PAP模式选择原则

## 一句话定义
根据病情与耐受性在 CPAP/APAP/BiPAP 中选择最合适模式。

## 选择逻辑
- CPAP：压力需求稳定。
- APAP：体位或 REM 波动明显。
- BiPAP：高压不耐受或通气不足。

## 关键参数
- 压力范围设定。
- 漏气控制与舒适度。

## FAQ
**Q：模式越高级越好吗？**  
A：并非，需按适应证选择。
""".strip(),
    "NIV适应证与禁忌证": """
# NIV适应证与禁忌证

## 一句话定义
NIV 用于通气不足或呼衰人群，但需排除禁忌证。

## 常见适应证
- COPD 高碳酸血症。
- OHS 与神经肌肉病。
- 夜间低通气。

## 禁忌提示
- 意识障碍或无法保护气道。
- 严重呕吐或面罩无法耐受。

## FAQ
**Q：家用 NIV 需要住院评估吗？**  
A：建议专业评估后再使用。
""".strip(),
    "ST与目标通气策略": """
# ST与目标通气策略

## 一句话定义
S/T 提供后备频率，AVAPS/iVAPS 以目标通气量自动调压。

## 适用场景
- 呼吸驱动不足。
- 通气需求波动明显。

## 关键参数
- 备份频率。
- 目标潮气量或分钟通气量。
- 最大/最小压力限制。

## FAQ
**Q：目标通气模式适合所有人吗？**  
A：需结合病情评估。
""".strip(),
    "滴定与调参逻辑": """
# 滴定与调参逻辑

## 一句话定义
先解决阻塞，再改善通气不足，最后优化舒适度与漏气。

## 调参步骤
1. 提高 EPAP/CPAP 控制阻塞。
2. 调整 IPAP/PS 改善通气。
3. 优化面罩与湿化提升耐受。

## 常见误区
- 忽视漏气导致调参失效。
- 没覆盖 REM/仰卧最差期。

## FAQ
**Q：多久调整一次？**  
A：通常 1-2 周复盘一次。
""".strip(),
    "漏气识别与处理": """
# 漏气识别与处理

## 一句话定义
漏气会影响事件识别与治疗效果，应优先处理。

## 识别方式
- 观察漏气曲线与报警。
- 区分面罩漏气与口漏。

## 处理顺序
1. 重新适配面罩。
2. 调整头带与睡姿。
3. 必要时微调压力。

## FAQ
**Q：漏气是否会影响 AHI？**  
A：会导致事件误判与疗效下降。
""".strip(),
    "面罩选择与适配": """
# 面罩选择与适配

## 一句话定义
面罩类型与尺寸决定舒适度与漏气水平。

## 选择要点
- 鼻枕：轻便但口漏敏感。
- 鼻罩：平衡选择。
- 全脸罩：口漏人群适用。

## 适配步骤
1. 选择合适尺寸。
2. 调整头带松紧。
3. 开机观察漏气。

## FAQ
**Q：面罩一定越紧越好？**  
A：过紧反而增加漏气与压痕。
""".strip(),
    "加湿与温度管理": """
# 加湿与温度管理

## 一句话定义
湿化改善干燥，但过湿会造成结露。

## 管理要点
- 冬季可适当提高湿化。
- 使用加温管路减少结露。
- 水箱每日清洁晾干。

## FAQ
**Q：结露会影响治疗吗？**  
A：主要影响舒适度与噪音。
""".strip(),
    "依从性评估与随访": """
# 依从性评估与随访

## 一句话定义
依从性是疗效核心指标，需持续随访。

## 常用口径
- 每晚 ≥4 小时、每周 ≥5 晚。

## 随访节奏
- 前 1-4 周重点适应。
- 每 1-3 个月复盘。

## FAQ
**Q：依从性差怎么办？**  
A：优先解决不适与漏气，再逐步延长时长。
""".strip(),
    "常见不适与处理策略": """
# 常见不适与处理策略

## 一句话定义
不适和焦虑是依从性下降的常见原因。

## 常见问题
- 鼻干、压痕、噪音。
- 焦虑、失眠、排斥感。

## 处理建议
- 优化面罩与湿化。
- 分段适应与心理支持。

## FAQ
**Q：不适就停用吗？**  
A：应先调整设备与设置。
""".strip(),
    "安全红线与就医提示": """
# 安全红线与就医提示

## 一句话定义
出现严重症状应优先就医而非自行调整。

## 就医红线
- 持续低氧或呼吸困难。
- 胸痛、咯血或意识改变。

## FAQ
**Q：报警一定要就医吗？**  
A：持续或无法解释的报警应就医。
""".strip(),
    "ASV相关风险提示": """
# ASV相关风险提示

## 一句话定义
ASV 适应证严格，部分心衰患者可能禁用。

## 风险提示
- 需评估心功能与中枢事件。
- 不能作为常规推荐模式。

## FAQ
**Q：可以自行切换 ASV 吗？**  
A：不建议，需专业评估。
""".strip(),
    "氧疗基础": """
# 氧疗基础

## 一句话定义
氧疗用于纠正低氧，高流量可改善氧合与舒适度。

## 关键要点
- 目标 SpO2 需个体化。
- COPD 患者注意 CO2 潴留。

## FAQ
**Q：氧疗能替代 PAP 吗？**  
A：不能，需根据病因选择治疗。
""".strip(),
    "雾化与吸入治疗要点": """
# 雾化与吸入治疗要点

## 一句话定义
雾化将药物送入气道，改善炎症与痉挛。

## 注意事项
- 粒径与接口影响沉积效率。
- 注意清洁与交叉感染。

## FAQ
**Q：可以接在呼吸机上使用吗？**  
A：需配合专业接口与流程。
""".strip(),
    "气道廓清与咳嗽辅助": """
# 气道廓清与咳嗽辅助

## 一句话定义
通过物理或机械手段促进痰液排出。

## 常见方法
- 体位引流、PEP、机械排痰。
- MI-E 咳嗽辅助。

## FAQ
**Q：需要每天做吗？**  
A：按病情与医生建议制定频率。
""".strip(),
    "COPD无创通气核心要点": """
# COPD无创通气核心要点

## 一句话定义
稳定期 COPD 高碳酸血症患者可考虑长期 NIV。

## 随访要点
- 血气改善与症状变化。
- 依从性与漏气监测。

## FAQ
**Q：多久复查一次？**  
A：建议 1-3 个月复查。
""".strip(),
    "OHS与夜间低通气": """
# OHS与夜间低通气

## 一句话定义
OHS 需结合体重管理与通气支持综合治疗。

## 治疗要点
- PAP/NIV 改善夜间通气。
- 长期体重管理。

## FAQ
**Q：减重后还需通气吗？**  
A：需复评决定是否减量或停用。
""".strip(),
    "神经肌肉疾病与通气支持": """
# 神经肌肉疾病与通气支持

## 一句话定义
呼吸肌无力人群需早期评估 NIV。

## 管理要点
- 评估 FVC 与夜间低通气。
- 结合咳嗽辅助与排痰。

## FAQ
**Q：何时开始 NIV？**  
A：出现夜间低通气或症状时评估。
""".strip(),
}

USER = {
    "呼吸机入门：PAP是什么？": """
# 呼吸机入门：PAP是什么？

## 一句话定义
PAP 是通过气道正压保持上气道通畅的治疗方式。

## 操作步骤
1. 了解 CPAP/APAP/BiPAP 的差异。
2. 在专业指导下试戴面罩。
3. 建立使用记录。

## 实用技巧
- 先适应舒适度，再追求时长。
- 使用湿化器减少鼻干。

## FAQ
**Q：PAP 适合所有打鼾的人吗？**  
A：需通过睡眠监测评估。
""".strip(),
    "家用无创通气NIV基础": """
# 家用无创通气NIV基础

## 一句话定义
NIV 用于通气不足人群，提供呼吸支持。

## 操作步骤
1. 评估适应证与禁忌证。
2. 设置 IPAP/EPAP 与备份频率。
3. 定期随访与复盘数据。

## 实用技巧
- 优先保证面罩密闭性。
- 逐步增加使用时长。

## FAQ
**Q：NIV 可以自行调参吗？**  
A：关键参数需专业指导。
""".strip(),
    "面罩选择与适配": """
# 面罩选择与适配

## 一句话定义
合适的面罩决定舒适度与漏气控制。

## 操作步骤
1. 选择面罩类型（鼻枕/鼻罩/全脸罩）。
2. 按尺寸表试戴。
3. 开机检查漏气。

## 实用技巧
- 头带不宜过紧。
- 翻身后重新调整贴合度。

## FAQ
**Q：面罩压痕怎么办？**  
A：调整头带或更换型号。
""".strip(),
    "漏气处理清单": """
# 漏气处理清单

## 一句话定义
漏气会影响疗效，需按顺序排查。

## 操作步骤
1. 检查面罩位置。
2. 调整头带松紧。
3. 排查口漏与鼻阻塞。

## 实用技巧
- 先解决漏气再调压力。

## FAQ
**Q：漏气数值过高怎么办？**  
A：优先调整面罩并复测。
""".strip(),
    "加湿与结露管理": """
# 加湿与结露管理

## 一句话定义
湿化改善干燥，过湿会导致结露。

## 操作步骤
1. 根据季节调整湿化档位。
2. 使用加温管路。
3. 清洁水箱并晾干。

## FAQ
**Q：结露会影响机器吗？**  
A：主要影响舒适度和噪音。
""".strip(),
    "依从性提升策略": """
# 依从性提升策略

## 一句话定义
依从性是疗效核心，需要持续管理。

## 操作步骤
1. 设定每周目标。
2. 记录使用时长与不适。
3. 按月复盘。

## FAQ
**Q：最低使用多长时间？**  
A：常用口径为每晚 ≥4 小时。
""".strip(),
    "常见不适与处理": """
# 常见不适与处理

## 一句话定义
鼻干、压痕、噪音是常见问题，可通过调整解决。

## 操作步骤
1. 优化面罩与湿化。
2. 调整压力或启用呼气减压。
3. 分段适应。

## FAQ
**Q：感觉憋气怎么办？**  
A：可考虑降低起始压力或呼气减压。
""".strip(),
    "设备清洁与维护": """
# 设备清洁与维护

## 一句话定义
规律清洁可降低感染与延长寿命。

## 操作步骤
1. 水箱每日清洗。
2. 管路每周清洗。
3. 过滤棉按月更换。

## FAQ
**Q：可以用酒精消毒吗？**  
A：多数配件不建议使用酒精。
""".strip(),
    "睡眠监测报告速读": """
# 睡眠监测报告速读

## 一句话定义
重点看 AHI、ODI、T90 与睡眠结构。

## 操作步骤
1. 先看总睡眠时间与效率。
2. 再看 AHI/ODI。
3. 结合体位与 REM 期。

## FAQ
**Q：AHI 正常就没问题吗？**  
A：还需结合症状与低氧负荷。
""".strip(),
    "外出与旅行使用": """
# 外出与旅行使用

## 一句话定义
旅行时需准备电源与备用配件，确保稳定使用。

## 操作步骤
1. 确认电压与适配器。
2. 准备备用面罩与管路。
3. 行前测试设备。

## FAQ
**Q：飞机上能用吗？**  
A：需提前确认航空公司政策。
""".strip(),
    "安全红线提示": """
# 安全红线提示

## 一句话定义
出现严重症状时需立即就医。

## 典型情况
- 持续低氧或呼吸困难。
- 意识改变、胸痛或咯血。

## FAQ
**Q：普通不适需要就医吗？**  
A：可先咨询随访团队，严重则就医。
""".strip(),
    "使用记录与复诊准备": """
# 使用记录与复诊准备

## 一句话定义
记录使用数据有助于复诊优化。

## 操作步骤
1. 记录使用时长与 AHI。
2. 标记不适与漏气。
3. 带数据复诊。

## FAQ
**Q：多久复诊一次？**  
A：一般 1-3 个月复盘。
""".strip(),
}


def main():
    clinical_text, clinical_data = load_array(CLINICAL_PATH, "clinicalHandbookData")
    user_text, user_data = load_array(USER_PATH, "publicUserLibraryData")

    for item in clinical_data:
        if item.get("title") in CLINICAL:
            content = CLINICAL[item["title"]]
            item["content"] = content
            item["summary"] = summary_from_content(content)

    for item in user_data:
        if item.get("title") in USER:
            content = USER[item["title"]]
            item["content"] = content
            item["summary"] = summary_from_content(content)

    save_array(CLINICAL_PATH, clinical_text, "clinicalHandbookData", clinical_data)
    save_array(USER_PATH, user_text, "publicUserLibraryData", user_data)


if __name__ == "__main__":
    main()
